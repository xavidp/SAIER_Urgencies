---
title: "SAIER Urgències"
author: "Ajuntament de Barcelona - AAI"
date: "27 novembre de 2017 - 27 febrer 2018"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Urgències SAIER 2017

Resultats destacats a partir de les dades de derivacions del CUESB al SAIER

```{r paquets, echo=FALSE}
if (!require("pacman")) install.packages("pacman")
#pacman::p_load_gh("trinker/textreadr")
pacman::p_load(leaflet.minicharts)
library(leaflet.minicharts)

#devtools::install_github("rstudio/crosstalk")
#devtools::install_github("rstudio/leaflet")
#devtools::install_github("jcheng5/d3scatter")

if (!require("readxl")) install.packages("readxl")
library(readxl)
if (!require("dplyr")) install.packages("dplyr")
library(dplyr)

# Allowi also Ploting Maps Using rworldmap
# Derived from: https://blog.learningtree.com/how-to-display-data-on-a-world-map-in-r/
  if (!require("rworldmap")) install.packages("rworldmap")
  library(rworldmap)

  
  # More libraries
  if (!require("treemap")) install.packages("treemap")
  library(treemap)
  if (!require("devtools")) install.packages("devtools")
  library(devtools)
  if (!require("d3treeR")) devtools::install_github("timelyportfolio/d3treeR")
  library(d3treeR)

# Add package widget frame so that we attempt to get responsive iframes produced by htmlwidgets such as theones from rpivotTable
# See: https://github.com/bhaskarvk/widgetframe
if(!require(widgetframe)){ install.packages("widgetframe") }
require(widgetframe)
if(!require(htmlwidgets)){ install.packages("htmlwidgets") }
require(htmlwidgets) 
if(!require(rpivotTable)){ install.packages("rpivotTable") }
require(rpivotTable)

# Add webshot to allos making screenshots from htmlwidgets for printed versions of reports
if(!require(webshot)){ install.packages("webshot") }
require(webshot)
# Install also phantomjs thorugh webshot as a required dependency (only once)
#webshot::install_phantomjs(baseURL = "https://bitbucket.org/ariya/phantomjs/downloads/")

```

```{r Lectura i pre-processat dades, echo=FALSE}
#Paths
htmlpath <- "html"

# -----------
# CUESB Data
# -----------
my_file <- file.path("K:\\QUOTA\\DIMM_COMU\\SAIER\\Urgències\ CUESB", "0 Base de dades_v12.xlsx")
# Read From xlsx sheet
# ..............................
# Option 1: readxl package
# ..............................
# From http://www.sthda.com/english/wiki/reading-data-from-excel-files-xls-xlsx-into-r
# The readxl package, developed by Hadley Wickham, can be used to easily import Excel files (xls|xlsx) into R without any external dependencies.

#Specify sheet with a number or name
# Specify sheet by its name
my_data <- read_excel(my_file, sheet = "Dades")
head(my_data)
my_data <- my_data %>% 
#  filter(ComunicacioDerivacio == "D" | ComunicacioDerivacio == "Derivació")
  filter(ComunicacioDerivacio == "DERIVACIÓ")
#colnames(my_data)


geodata <- read_excel(my_file, sheet = "PaisesContinentes")

# Summarise data based on Country of origin
my_data4 <- count(my_data, NacionalitatAngles, MesDerivacioSAIER, GrupEdat, HomeDona, wt = NULL, sort = FALSE)
#colnames(my_data4)
my_data4$NacionalitatAngles <- apply(my_data4, 2, toupper)
head(my_data4)
#dim(my_data4)

#colnames(geodata)[7] <- "NacionalitatAngles"
#colnames(geodata)
head(geodata)
#dim(geodata)

# Add coordinates to the countries from the Dades sheet, using left_join
my_data5 <- my_data4 %>% left_join(geodata, by = c("NacionalitatAngles" = "PaisAngles"))

my_data5b <- my_data5 %>%
  # filter(grepl("EUROPA", ContinentNacion.)) %>%
  select(NacionalitatAngles,
         MesDerivacioSAIER,
         GrupEdat,
         HomeDona,
         n,
         lon,
         lat
  ) %>%
  #    group_by(Nacionalitat_Angles) %>%
  #    summarise_all(sum) %>%
  ungroup()

head(my_data5b)



```

## Gender of immigrants. World map with pie charts integrated overtime

```{r Gender of immigrants}
  
  library(leaflet)
  
  tilesURL <- "http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}"
  
  basemap <- leaflet(width = "100%", height = "400px") %>%
    addTiles(tilesURL)
  
  # -------------------------------------------------------------
  my_data5d <- count(my_data, NacionalitatAngles, HomeDona, wt = NULL, sort = FALSE)
  my_data5d <- tidyr::spread(my_data5d, HomeDona, n)
  colnames(my_data5d)[4] <- "Desconegut"
  my_data5d$NacionalitatAngles <- apply(my_data5d, 2, toupper)
  # Add coordinates to the countries from the Dades sheet, using left_join
  my_data5e <- my_data5d %>% left_join(geodata, by = c("NacionalitatAngles" = "PaisAngles"))
  my_data5e <- my_data5e %>%
    # filter(grepl("EUROPA", ContinentNacion.)) %>%
    select(NacionalitatAngles,
           Dona,
           Home,
           Desconegut,
           lon,
           lat
    ) %>%
    #    group_by(Nacionalitat_Angles) %>%
    #    summarise_all(sum) %>%
    ungroup()
  
  head(my_data5e)
  
  #We now add to the base map a pie chart for each country of origin
  #  colors <- c("#4fc13c", "lightyellow", "#cccccc")
  colors <- c("pink", "lightblue", "lightyellow")
  
  leaflet.2017.gender <- basemap %>%
    addMinicharts(
      my_data5e$lon, my_data5e$lat,
      type = "pie",
      chartdata = my_data5e[, c("Dona", "Home", "Desconegut")], 
      fillColor = "white",
      colorPalette = colors, 
      transitionTime = 0,
      legend=TRUE,
      legendPosition = "topright"
    )
  
  saveWidget(leaflet.2017.gender, file=file.path(getwd(), htmlpath, "2017.leaflet.gender.html"), selfcontained=TRUE) 
  leaflet.2017.gender

```

## Age group of immigrants. World map with pie charts
```{r Age group of immigrants}

  # Map Age group of immigrants in pie charts over the world map
  # -------------------------------------------------------------
  my_data6 <- count(my_data, NacionalitatAngles, GrupEdat, wt = NULL, sort = FALSE)
  my_data6b <- tidyr::spread(my_data6, GrupEdat, n)
  colnames(my_data6b)[4] <- "desconegut"
  my_data6b$NacionalitatAngles <- apply(my_data6b, 2, toupper)
  # Add coordinates to the countries from the Dades sheet, using left_join
  my_data6c <- my_data6b %>% left_join(geodata, by = c("NacionalitatAngles" = "PaisAngles"))
  
  my_data6d <- my_data6c %>%
    # filter(grepl("EUROPA", ContinentNacion.)) %>%
    select(NacionalitatAngles,
           Adult,
           Menor,
           desconegut,
           lon,
           lat
    ) %>%
    #    group_by(Nacionalitat_Angles) %>%
    #    summarise_all(sum) %>%
    ungroup()
  
  head(my_data6d)
  
  colors <- c("green", "lightgreen", "orange")
  
  basemap %>%
    addMinicharts(
      my_data6d$lon, my_data6d$lat,
      type = "pie",
      chartdata = my_data6d[, c("Adult", "Menor", "desconegut")], 
      fillColor = "white",
      colorPalette = colors, 
      transitionTime = 0,
      legend=TRUE,
      legendPosition = "topright"
    )

  
  # Pending-1
  # =======================================================
  # Test adding an easy interface to allow changing htmlwidget on the go with manipulatewidget
  # See: https://github.com/rte-antares-rpackage/manipulateWidget
  # =======================================================
  # 
  #
  #   if (!require("manipulateWidget")) install.packages("manipulateWidget")

```

## Membres de les Unitats Familiars
```{r Membres de les Unitats Familiars}
# Plot Map Using rworldmap

  my_mapped_data <- joinCountryData2Map(my_data, joinCode = "NAME", 
                                     nameJoinColumn = "NacionalitatAngles")

  # The par command only needs to be performed once in the session and just makes sure that all the available space in the window is used to display the map.
  par(mai=c(0,0,0.2,0),xaxs="i",yaxs="i")

  my_mapped_data$NMembresNucli <- as.numeric(my_mapped_data$NMembresNucli)
  mapCountryData(my_mapped_data, 
                 nameColumnToPlot = "NMembresNucli", 
                 catMethod="pretty",
                 colourPalette="heat", 
                 mapTitle = "columnName", 
                 oceanCol = "lightblue",
                 missingCountryCol = "white")
  
  # Pending-2
  # =======================================================
  # Improve type of chart with the thematic maps package
  # See: https://github.com/mtennekes/tmap
  # =======================================================
  # 
  #
  #   if (!require("tmap")) install.packages("tmap")

```


### Resum de dades de N. de membres del Nucli

```{r resum numero membres del nucli, echo=FALSE}

  head(my_data)
  table(my_data$NMembresNucli)
  
```


## Nacionalitats SAIER per anys

```{r Nacionalitats SAIER per anys - intro, echo=FALSE}
  
  # ---------------------------------------------------------
  # Nacionalitats SAIER per anys
  # ---------------------------------------------------------
  # Dades a: K:\QUOTA\DIMM_COMU\Maria\NACIONALITATS REFUGI_tancament 2015-2016 a juny 2016-2017.xlsx > Full1 
  #
  # Full1 	CATEGORIA 	a des. 2015 	a des. 2016 	ANY 2016 vs ANY 2015 	% creix. Anual
  # AFGANISTAN 	ÀSIA MERIDIONAL 	17 	35 	18 	51,43%
  # ALBANIA 	EUROPA ORIENTAL 	8 	17 	9 	52,94% 
  # ...
  my_file2 <- file.path("K:\\QUOTA\\DIMM_COMU\\Maria", "NACIONALITATS REFUGI_tancament 2015-2016 a juny 2016-2017_v02.xlsx")

  my_data10 <- read_excel(my_file2, sheet = "Full1", range="A5:AJ125", na="NA")
  head(my_data10)
  #colnames(my_data10)
  
```


### Nacionalitats SAIER 2015 

```{r Treemap 2015, echo=FALSE}

  #md2 <- count(my_data10, CATEGORIA, NACIONALITAT, wt = NULL, sort = FALSE)
  md10 <- my_data10
  # basic treemaps
  p2015=treemap(md10,
            index=c("CATEGORIA","NACIONALITAT"),
            vSize="a des. 2015",
            type="index",
            title="Nacionalitats d'Usuaris al SAIER 2015",
            overlap.labels=1,
            force.print.labels=TRUE,
            aspRatio=2,
            align.labels=c("center", "center")
  )  
  
```


### Nacionalitats SAIER 2016

```{r Treemap 2016, echo=FALSE}
  p2016=treemap(md10,
                index=c("CATEGORIA","NACIONALITAT"),
                vSize="a des. 2016",
                type="index",
                title="Nacionalitats d'Usuaris al SAIER 2016",
                overlap.labels=1,
                force.print.labels=TRUE,
                aspRatio=2.5,
                bg.labels=75,
                align.labels=c("center", "center")
  )            
  # md10$"% creix. Anual"
  # md10$"% 2016 vs 2015"
  # md10$NACIONALITAT
  # length(md10$NACIONALITAT)

  p2016b=treemap(md10,
                index=c("CATEGORIA","NACIONALITAT"),
                vSize="a des. 2016",
                title="Nacionalitats d'Usuaris al SAIER 2016",
                title.legend="Mida proporcional al nombre; color segons % de canvi anual",
#                type="dens",
#                vColor="% 2016 vs 2015",
                type="comp",
                vColor="a des. 2015",
                palette="RdYlBu",
                overlap.labels=1,
                aspRatio=2.5,
                force.print.labels=TRUE,
                align.labels=c("center", "center")
  ) 
  # To see all possible easy color palettes, run:
  #RColorBrewer::display.brewer.all()
  
```


### Nacionalitats Usuaris SAIER - Interactive Chart 2015
```{r Nacionalitats Usuaris SAIER - Interactive Chart 2015}
  # make it interactive ("rootname" becomes the title of the plot):
  inter2015=d3tree2( p2015 ,  rootname = "Nacionalitats Usuaris SAIER - 2015" )
  inter2015
```


### Nacionalitats Usuaris SAIER - Interactive Chart 2016
```{r Nacionalitats Usuaris SAIER - Interactive Chart 2016}
  inter2016=d3tree2( p2016 ,  rootname = "Nacionalitats Usuaris SAIER - 2016" )
  inter2016
  
```


### Nacionalitats Usuaris SAIER - Interactive Chart 2016 vs 2015
```{r Nacionalitats Usuaris SAIER - Interactive Chart 2016 vs 2015}
  inter2016b=d3tree2( p2016b ,  rootname = "Nacionalitats Usuaris SAIER - 2016 vs 2015" )
  inter2016b
  

```


## Derivacions CUESB -> SAIER 2017

### Derivacions CUESB -> SAIER 2017: Nacionalitats

```{r Derivacions CUESB -> SAIER 2017}

    my_data7a <- my_data %>% 
          count(NacionalitatAngles, 
                ContinentNacio,
                MesDerivacioSAIER,
                wt = NULL, sort = FALSE) %>%
          filter(!is.na(NacionalitatAngles))

    my_data7b <- my_data %>% 
          count(ProcedenciaAngles,
                ContinentProced,
                MesDerivacioSAIER,
                wt = NULL, sort = FALSE) %>%
          filter(!is.na(ProcedenciaAngles))

    my_data7c <- my_data %>% 
          count(SituacioAdministrativa,
                PaisTramitSituacioAdministrativa,
                Perfil, 
                MesDerivacioSAIER,
                wt = NULL, sort = FALSE)

  # basic treemaps
  p2017.nacio=treemap(my_data7a,
            index=c("ContinentNacio","NacionalitatAngles"),
            vSize="n",
            type="index",
            title="Nacionalitats d'Usuaris Derivats del CUESB al SAIER 2017",
            overlap.labels=1,
            force.print.labels=TRUE,
            aspRatio=2,
            align.labels=c("center", "center")
  )  

  # Pending-3
  # =======================================================
  # Test adding svgPanZoom capabilities to these treemaps
  # See: https://github.com/timelyportfolio/svgPanZoom
  # =======================================================
  # 
  #
  # devtools::install_github("timelyportfolio/svgPanZoom")
  #library(svgPanZoom) # see install step above
  #library(svglite)
  #
  #svgPanZoom(
  #  svglite:::inlineSVG(
  #    plot(1:10)
  #  )
  #)
  #


  
```
### Derivacions CUESB -> SAIER 2017: Nacionalitats Interactive Chart 2017
```{r Derivacions CUESB -> SAIER 2017: Nacionalitats Interactive Chart 2017}
  p2017.nacio.i=d3tree2( p2017.nacio ,  rootname = "Nacionalitats d'Usuaris Derivats del CUESB al SAIER 2017" )
  p2017.nacio.i
  
```

## Immigrants vs Refugiats Atesos

```{r Immigrants vs Refugiats atesos, echo=FALSE}

# Create the pivot table and save html on disk
#pt <- rpivotTable(my_data7c)
pt.2017.SA <- rpivotTable(
  data = my_data7c, 
  rows = c("MesDerivacioSAIER"), 
  cols=c("SituacioAdministrativa"), 
  vals = "n", 
  aggregatorName = "Sum", 
  width="1200px", 
  height="800px",   
#  inclusions = list( Perfil = list("NO CONSTA")),
  exclusions = list( MesDerivacioSAIER = list( "2018-01")),
  rendererName = "Heatmap"
  )
frameWidget(pt.2017.SA)
#getwd()
#file.path(htmlpath, "2017.pt.SituacioAdministrativa.html")
saveWidget(pt.2017.SA, file=file.path(getwd(), htmlpath, "2017.pt.SituacioAdministrativa.html"), selfcontained=TRUE) 

pt.2017.SA


```

## Situació Administrativa vs. Perfil

```{r Situació Administrativa vs. Perfil}

# Sample Sankey Diagram - http://christophergandrud.github.io/networkD3/#sankey
# Through networkD3

if(!require(networkD3)){ install.packages("networkD3") }
require(networkD3)
require(dplyr)
require(htmlwidgets)

my_data8 <- my_data %>% 
  filter(AnyDerivText == 2017) %>%
  count(SituacioAdministrativa, 
        Perfil,
        wt = NULL, sort = FALSE) 

my_data8b <- my_data8 

my_data8b$SituacioAdministrativa <-  recode(my_data8$SituacioAdministrativa,
         "Nouvingut asil (han de fer la sol·licitud)"   = 0,
         "Voluntat de fer sol·licitud asil"             = 1,
         "Sol·licitant de protecció internacional (PI)" = 2,
         "Denegat PI a Espanya"                         = 3,
         "Denegat PI a altre país UE"                   = 4,
         "Estatut PI concedit"                          = 5,
         "Immigrant Situació Regular"                   = 6,
         "Immigrant Situació Irregular"                 = 7,
         "NO CONSTA"                                    = 8
         )

my_data8b$Perfil <-  recode(my_data8$Perfil,
          "Immigrant amb menys de 2 anys a Espanya"                   = 9,
          "Immigrant amb més de 2 anys a Espanya"                     = 10,
          "En programa estatal (Refugiat)"                            = 11,
          "Trasllat de província (Refugiat)"                          = 12,
          "Fora de programa (Refugiat)"                               = 13,
          "Pendent d'Entrada a Programa (Refugiat)"                   = 14,
          "Protocol Dublín (Aeroport) (Refugiat)"                     = 15,
          "Sol·licitant asil aeroport (Refugiat)"                     = 16,
          "Decretada o recent majoria d'edat (Refugiat o Immigrant)"  = 17,
          "NO CONSTA"                                                 = 18,
          "Voluntat de sol·licitar asil"                              = 19
          )

nodeNames.SituacioAdministrativa <- c(
         "Nouvingut asil (han de fer la sol·licitud)",       # Node  0
         "Voluntat de fer sol·licitud asil",                 # Node  1
         "Sol·licitant de protecció internacional (PI)",     # Node  2
         "Denegat PI a Espanya",                             # Node  3
         "Denegat PI a altre país UE",                       # Node  4
         "Estatut PI concedit",                              # Node  5
         "Immigrant Situació Regular",                       # Node  6
         "Immigrant Situació Irregular",                     # Node  7
         "NO CONSTA"                                         # Node  8
         )                                        

nodeNames.Perfil <- c(
          "Immigrant amb menys de 2 anys a Espanya",                  # Node  9
          "Immigrant amb més de 2 anys a Espanya",                    # Node 10
          "En programa estatal (Refugiat)",                           # Node 11
          "Trasllat de província (Refugiat)",                         # Node 12
          "Fora de programa (Refugiat)",                              # Node 13
          "Pendent d'Entrada a Programa (Refugiat)",                  # Node 14
          "Protocol Dublín (Aeroport) (Refugiat)",                    # Node 15
          "Sol·licitant asil aeroport (Refugiat)",                    # Node 16
          "Decretada o recent majoria d'edat (Refugiat o Immigrant)", # Node 17
          "NO CONSTA",                                                # Node 18
          "Voluntat de sol·licitar asil"                              # Node 19
          )

nodes = data.frame("name" = c(nodeNames.SituacioAdministrativa, nodeNames.Perfil ))
links = my_data8b
 # How this data frame my_data8b is setup for the Sankey Diagram.
 # Each row represents a link. 
 # The first number represents the node being conntected from. 
 # The second number represents the node connected to.
 # The third number is the value of the node

names(links) = c("source", "target", "value")
sankey.2017.sa.p <- sankeyNetwork(Links = links, 
              Nodes = nodes,
              Source = "source",
              Target = "target",
              Value = "value",
              NodeID = "name",
              fontSize= 12,
              nodeWidth = 30)

saveWidget(sankey.2017.sa.p, file=file.path(getwd(), htmlpath, "2017.sankey.sa.p.html"), selfcontained=TRUE) 

sankey.2017.sa.p

```

